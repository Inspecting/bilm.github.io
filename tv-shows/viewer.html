<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bilm ðŸ’œ - TV Show Viewer</title>
  <style>
    /* Base and reset */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%; background: #121212; color: #f0f0f0;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex; flex-direction: column;
    }
    body { overflow: hidden; }

    header {
      background: #1e1e1e;
      padding: 12px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      position: sticky; top: 0; z-index: 1000;
      display: flex; justify-content: center; align-items: center;
    }

    main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #player-wrapper {
      width: 90vw;
      max-width: 800px;
      position: relative;
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 15px #a14effaa;
      margin-bottom: 16px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      background: #000;
    }

    #controls {
      width: 90vw;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    select {
      background: #2a2a2a;
      border: none;
      border-radius: 8px;
      color: #eee;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      user-select: none;
      flex: 1 1 120px;
    }

    button#fullscreenBtn {
      background-color: #3a1361;
      border: none;
      color: #fff;
      padding: 8px 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
      flex: 0 0 auto;
    }

    button#fullscreenBtn:hover {
      background-color: #a855f7;
    }

    /* Minimal ad blocking container to hide */
    .ad-container, #ads, .ad-banner, .ad-slot {
      display: none !important;
    }
  </style>
</head>
<body>

<header>
  <h1>Bilm ðŸ’œ - TV Show Viewer</h1>
</header>

<main>
  <div id="player-wrapper">
    <iframe
      id="player"
      allowfullscreen
      allow="fullscreen; encrypted-media"
      playsinline
      src=""
      title="TV Show Player"
      sandbox="allow-same-origin allow-scripts allow-forms allow-pointer-lock allow-popups"
    ></iframe>
  </div>

  <div id="controls">
    <select id="seasonSelect" aria-label="Select Season"></select>
    <select id="episodeSelect" aria-label="Select Episode"></select>
    <button id="fullscreenBtn" aria-label="Go Fullscreen">Fullscreen</button>
  </div>
</main>

<script>
  // Helper to get URL param by name
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  // Minimal ad blocking: remove known ad containers if any appear (just in case)
  function minimalAdBlock() {
    const adSelectors = ['.ad-container', '#ads', '.ad-banner', '.ad-slot'];
    adSelectors.forEach(sel => {
      document.querySelectorAll(sel).forEach(el => el.style.display = 'none');
    });
  }

  // Fullscreen helper
  function goFullscreen(el) {
    if (el.requestFullscreen) {
      el.requestFullscreen();
    } else if (el.webkitRequestFullscreen) {
      el.webkitRequestFullscreen();
    } else if (el.msRequestFullscreen) {
      el.msRequestFullscreen();
    }
  }

  const iframe = document.getElementById('player');
  const seasonSelect = document.getElementById('seasonSelect');
  const episodeSelect = document.getElementById('episodeSelect');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  let tvId = getParam('id');
  if (!tvId) {
    alert('TV Show ID missing in URL');
    throw new Error('Missing TV show id');
  }

  // Storage key to remember last watched season & episode per show
  const storageKey = `bilm-tvshow-${tvId}-lastwatched`;

  // Default selections
  let currentSeason = 1;
  let currentEpisode = 1;

  // Fetch show details (to get seasons & episodes info)
  async function fetchShowDetails() {
    try {
      // Use TMDB API to fetch details
      const TMDB_API_KEY = '3ade810499876bb5672f40e54960e6a2';
      const url = `https://api.themoviedb.org/3/tv/${tvId}?api_key=${TMDB_API_KEY}&language=en-US`;
      const res = await fetch(url);
      const data = await res.json();

      return data;
    } catch(e) {
      console.error('Failed to load show details', e);
      return null;
    }
  }

  // Load saved season/episode from localStorage
  function loadLastWatched() {
    const saved = localStorage.getItem(storageKey);
    if (saved) {
      try {
        const obj = JSON.parse(saved);
        if (obj.season) currentSeason = obj.season;
        if (obj.episode) currentEpisode = obj.episode;
      } catch {}
    }
  }

  // Save season/episode to localStorage
  function saveLastWatched(season, episode) {
    localStorage.setItem(storageKey, JSON.stringify({season, episode}));
  }

  // Populate season and episode selectors
  function populateSelectors(seasons) {
    seasonSelect.innerHTML = '';
    episodeSelect.innerHTML = '';

    seasons.forEach(season => {
      if (season.season_number === 0) return; // Skip specials if you want
      const opt = document.createElement('option');
      opt.value = season.season_number;
      opt.textContent = `Season ${season.season_number}`;
      seasonSelect.appendChild(opt);
    });

    seasonSelect.value = currentSeason;

    updateEpisodeSelect(seasons, currentSeason);

    seasonSelect.onchange = () => {
      currentSeason = parseInt(seasonSelect.value);
      updateEpisodeSelect(seasons, currentSeason);
      loadEpisode(currentSeason, currentEpisode);
      saveLastWatched(currentSeason, currentEpisode);
    };

    episodeSelect.onchange = () => {
      currentEpisode = parseInt(episodeSelect.value);
      loadEpisode(currentSeason, currentEpisode);
      saveLastWatched(currentSeason, currentEpisode);
    };
  }

  // Update episode select options based on selected season
  function updateEpisodeSelect(seasons, seasonNumber) {
    episodeSelect.innerHTML = '';
    const season = seasons.find(s => s.season_number === seasonNumber);
    if (!season) return;
    for(let ep=1; ep <= (season.episode_count || 1); ep++) {
      const opt = document.createElement('option');
      opt.value = ep;
      opt.textContent = `Episode ${ep}`;
      episodeSelect.appendChild(opt);
    }
    // Try keep current episode if still valid else fallback
    if (currentEpisode <= season.episode_count) {
      episodeSelect.value = currentEpisode;
    } else {
      currentEpisode = 1;
      episodeSelect.value = '1';
    }
  }

  // Load episode stream in iframe
  function loadEpisode(season, episode) {
    // Format URL for vidsrc.xyz embed for tv show episode
    const streamUrl = `https://vidsrc.xyz/embed/tv/${tvId}/${season}-${episode}`;
    iframe.src = streamUrl;
  }

  fullscreenBtn.onclick = () => {
    goFullscreen(document.getElementById('player-wrapper'));
  };

  async function init() {
    minimalAdBlock();
    loadLastWatched();
    const details = await fetchShowDetails();
    if (!details || !details.seasons) {
      alert('Failed to load TV show details');
      return;
    }
    populateSelectors(details.seasons);
    loadEpisode(currentSeason, currentEpisode);
  }

  window.onload = init;
</script>

</body>
</html>
