const TMDB_API_KEY = '3ade810499876bb5672f40e54960e6a2';
const OMDB_API_KEY = '9bf8cd26';
const BASE_URL = 'https://inspecting.github.io/bilm.github.io';

const urlParams = new URLSearchParams(window.location.search);
const currentQuery = urlParams.get('q') || '';

const searchInput = document.getElementById('searchInput');
const resultsTitle = document.getElementById('resultsTitle');
const moviesSection = document.getElementById('moviesSection');
const tvSection = document.getElementById('tvSection');
const moviesResults = document.getElementById('moviesResults');
const tvResults = document.getElementById('tvResults');

searchInput.value = currentQuery;
resultsTitle.textContent = `Search Results for "${currentQuery}"`;

document.getElementById('searchBtn').addEventListener('click', () => {
  const query = searchInput.value.trim();
  if (query) {
    window.location.href = `${BASE_URL}/home/search.html?q=${encodeURIComponent(query)}`;
  }
});

searchInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    document.getElementById('searchBtn').click();
  }
});

if (currentQuery) {
  Promise.all([
    fetch(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(currentQuery)}`).then(r => r.json()),
    fetch(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(currentQuery)}`).then(r => r.json()),
    fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(currentQuery)}&apikey=${OMDB_API_KEY}&type=movie`).then(r => r.json()),
    fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(currentQuery)}&apikey=${OMDB_API_KEY}&type=series`).then(r => r.json())
  ])
  .then(([tmdbMovies, tmdbTV, omdbMovies, omdbTV]) => {
    const movieMap = new Map();
    const tvMap = new Map();

    (tmdbMovies.results || []).forEach(item => {
      const key = `${item.title}-${item.release_date?.slice(0, 4)}`;
      if (!movieMap.has(key)) {
        movieMap.set(key, {
          title: item.title,
          year: item.release_date?.slice(0, 4) || 'N/A',
          img: item.poster_path
            ? `https://image.tmdb.org/t/p/w500${item.poster_path}`
            : 'https://via.placeholder.com/140x210?text=No+Image',
          link: `${BASE_URL}/movies/viewer.html?id=${item.id}`,
          source: 'TMDB'
        });
      }
    });

    (tmdbTV.results || []).forEach(item => {
      const key = `${item.name}-${item.first_air_date?.slice(0, 4)}`;
      if (!tvMap.has(key)) {
        tvMap.set(key, {
          title: item.name,
          year: item.first_air_date?.slice(0, 4) || 'N/A',
          img: item.poster_path
            ? `https://image.tmdb.org/t/p/w500${item.poster_path}`
            : 'https://via.placeholder.com/140x210?text=No+Image',
          link: `${BASE_URL}/tv-shows/viewer.html?id=${item.id}`,
          source: 'TMDB'
        });
      }
    });

    (omdbMovies.Search || []).forEach(item => {
      const key = `${item.Title}-${item.Year}`;
      if (!movieMap.has(key)) {
        movieMap.set(key, {
          title: item.Title,
          year: item.Year,
          img: item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/140x210?text=No+Image',
          link: `https://www.imdb.com/title/${item.imdbID}`,
          source: 'OMDB'
        });
      }
    });

    (omdbTV.Search || []).forEach(item => {
      const key = `${item.Title}-${item.Year}`;
      if (!tvMap.has(key)) {
        tvMap.set(key, {
          title: item.Title,
          year: item.Year,
          img: item.Poster !== 'N/A' ? item.Poster : 'https://via.placeholder.com/140x210?text=No+Image',
          link: `https://www.imdb.com/title/${item.imdbID}`,
          source: 'OMDB'
        });
      }
    });

    renderResults(moviesResults, Array.from(movieMap.values()));
    renderResults(tvResults, Array.from(tvMap.values()));

    if (movieMap.size === 0) {
      moviesSection.innerHTML = '<p class="no-results">No movies found.</p>';
    }
    if (tvMap.size === 0) {
      tvSection.innerHTML = '<p class="no-results">No TV shows found.</p>';
    }
  })
  .catch(err => {
    console.error('Search failed', err);
    moviesSection.innerHTML = '<p class="no-results">Failed to load results.</p>';
    tvSection.innerHTML = '';
  });
} else {
  moviesSection.innerHTML = '<p class="no-results">Please enter a search term.</p>';
  tvSection.innerHTML = '';
}

function renderResults(container, items) {
  container.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'card';

    const img = document.createElement('img');
    img.src = item.img;
    img.alt = item.title;

    const title = document.createElement('p');
    title.textContent = `${item.title} (${item.year})`;

    card.appendChild(img);
    card.appendChild(title);

    card.dataset.source = item.source || 'Unknown';

    card.onclick = () => {
      console.log(`Clicked on "${item.title}" from API: ${card.dataset.source}`);
      window.location.href = item.link;
    };

    container.appendChild(card);
  });
}